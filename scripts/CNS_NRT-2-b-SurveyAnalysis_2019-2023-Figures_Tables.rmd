---
title: "CNS_NRT-2b-SurveyAnalysis_2019-2023"
output: 
  pdf_document: default
---

#### Environment Setup ####

```{r env, message=FALSE, warning=FALSE, include=FALSE}
#rm(list=ls())
  
# Libraries
library(tidyr)        # Tidyverse 
library(reshape2)     # Data Shaping
library(plyr)         # Data shaping
library(dplyr)        # Data shaping
library(forcats)      # Factor manipulation
library(stringr)      # String manipulation
library(magrittr)     # Piping
library(ggplot2)      # Figures
library(patchwork)    # Grammar for combining figures
library(grid)         # Figure layouts
library(gridExtra)    # Figure layouts
library(knitr)        # R Markdown
library(kableExtra)   # Table printing
```

```{r vis_opts}
# # Global Options
# Set CNS-NRT figure theme
theme_nrt <- theme_grey()
theme_set(theme_nrt)
theme_update(
		    plot.background = element_rect(fill="White"),
	    	plot.caption.position = "plot",
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.background = element_rect(fill="White"),
        panel.border = element_rect(fill=NA, 
                                    color="black",
                                    linetype="solid")
)
```

####Data Preparation ####

```{r load-data, include=FALSE}
#### Data Path ####
path_s <- c("../data/survey/")
getwd()

#### Load Survey Responses####
data <- read.csv(file=paste0(path_s,"CNS_NRT-SurveyResponses_2019-2023-2025prep.csv"), 
                 header = T, sep=",") 
data$Progress <- as.numeric(data$Progress)

# All NRT question responses
d_all_m <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_general_meta.csv"), 
                    header = T, sep=",")
d_all   <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_general.csv"),
                    header = T, sep=",")

# NRT Faculty question responses
d_fac   <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_faculty.csv"),
                    header = T, sep=",")
d_fac_m <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_faculty_meta.csv"),
                    header = T, sep=",")

# NRT Student question responses
d_std_m <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_students_meta.csv"),
                    header = T, sep=",")
d_std   <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_students.csv"),
                    header = T, sep=",")

# NRT Student question responses
d_cont_m <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_continue_meta.csv"),
                    header = T, sep=",")
d_cont  <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_continue.csv"),
                    header = T, sep=",")

# NRT Qualitative responses
d_qual_m <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_qual_meta.csv"), 
                     header = T, sep=",")
d_qual   <- read.csv(file=paste0(path_s,"CNS_NRT-Survey_2019-2023_qual.csv"), 
                     header = T, sep=",")

#### Load Response Summary Statistics
rep <- read.csv(file=paste0(path_s,"CNS_NRT-SurveyResponseRates_2019-2023.csv"), 
                 header = T, sep=",") 
```

```{r prepare-data}
#### Common factor variables ####
# Factor scales
roles <- c("Faculty","Fellow","Affiliate","Admin")
likerts <- c("Strongly Disagree", "Disagree", "Somewhat Disagree",
             "Somewhat Agree", "Agree", "Strongly Agree","Not Applicable")
yn <- c("Not applicable","No","Yes")

# General Question - All Participants 
d_all$Role <- ordered(d_all$Role, levels=roles)
d_all$Group <- factor(d_all$Group)
d_all$Item <- ordered(d_all$Item, 
                      levels=c("Overall Goals","Disseminate Research",
                               "Local Awareness","National Awareness",
                               "COVID-19"))
d_all <- d_all %>% filter(Value!="Not Applicable")
d_all$Value <- ordered(d_all$Value, levels=likerts[c(1:6)])

# Continuation of CNS NRT Activities
d_cont$Role <- ordered(d_cont$Role, levels=roles)
d_cont$Group <- factor(d_cont$Group)
d_cont$Item <- factor(d_cont$Item)

# Faculty Questions
d_fac$Role <- ordered(d_fac$Role, levels=roles)
d_fac$Group <- factor(d_fac$Group)
d_fac$Item <- factor(d_fac$Item)
d_fac <- d_fac %>% filter(Value!="Not Applicable")
d_fac$Value <- ordered(d_fac$Value, levels=likerts[c(1:6)])

# Doctoral Fellow Questions - Binary - Yes & No
d_std_b <- d_std[d_std$Value %in% c("Yes","No"),]
d_std_b$Role <- ordered(d_std_b$Role, levels=roles)
d_std_b$Group <- factor(d_std_b$Group)
d_std_b$Value <- ordered(d_std_b$Value, levels=yn[1:3])

# Doctoral Fellow Questions  - Likert Scales
d_std <- 
  d_std %>% 
  filter(Value!="Yes" | Value!="No") %>%
  filter(Value!= "Not Applicable")
d_std$Role <- ordered(d_std$Role, levels=roles)
d_std$Group <- factor(d_std$Group)
d_std$Value <- ordered(d_std$Value, levels=likerts[1:6])

# Qualitative Questions
d_qual$Role <- ordered(d_qual$Role, levels=roles)
d_qual$Group <- factor(d_qual$Group)
d_qual$Item <- factor(d_qual$Item)
```

####Table 5: Survey Response Statistics ####

```{r response_stats}
# Response statistics
names(rep)[2] <- "Role"
# Overall
rep_overall <- rep[rep$Role == "Overall",]
rep_overall <- rep_overall[,c(1,3:4,7,6,9)]
row.names(rep_overall) <- 1:nrow(rep_overall)
rep_overall[,c(4,6)] <- rep_overall[,c(4,6)]*100
rep_overall <- 
  rbind(rep_overall,
        c("2019-2023",
          sum(rep_overall$Invitation),
          sum(rep_overall$Responses),
          round(sum(rep_overall$Responses)/sum(rep_overall$Invitation)*100,1),
          sum(rep_overall$Responses.Used),
          round(sum(rep_overall$Responses.Used)/sum(rep_overall$Invitation)*100,1)))
rep_overall[,c(2,3,5)] <- as.integer(unlist(rep_overall[,c(2,3,5)]))
rep_overall[,c(4,6)] <- as.numeric(unlist(rep_overall[,c(4,6)]))
write.csv(rep_overall, "../tables/Table5-CNS_NRT-Survey_2019-2023-ResponseRates-overall.csv",
          row.names = F)
names(rep_overall) <- c("Year(s)","Invitations","Total Responses",
                        "Total Resp.\nRate (%)",
                        "Completed (>40%)\nResponses",
                        "Completed Resp.\nRate (%)")
```

####Table 6: Survey Response by NRT Roles ####

```{ r responses_stats_role}
# By Role
rep <- rep[rep$Role != "Overall",]
row.names(rep) <- 1:nrow(rep)
rep$Role <- ordered(rep$Role, levels=roles)
rep <- rep[,c(1:4,7,6,9)]
write.csv(rep, "../tables/Table6-CNS_NRT-Survey_2019-2023-ResponseRates-role.csv",
          row.names = F)
names(rep) <- c("Year","NRT Role","Invitations","Total Responses",
                "Total Resp.\nRate (%)",
                "Completed (>40%)\nResponses","Completed Resp.\nRate (%)")
rep[,c(5,7)] <- rep[,c(5,7)]*100
```

####Appendix: Annual Survey Responce Statistics ####

```{r resp-overall, echo=FALSE, paged.print=TRUE}
rep_overall %>% 
  kbl(caption="CNS NRT Annual Survey Response Statistics (2019-2023)", 
      centering = TRUE, align="r") %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "hold_position") %>% 
  column_spec(1:6, width="6em") 
```

```{r resp-role, echo=FALSE, paged.print=TRUE}
rep %>% 
  kbl(caption="CNS NRT Annual Survey Response Statistics (2019-2023), by Role", 
      centering = TRUE,) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "hold_position") %>% 
  column_spec(2, width="3em") %>%
  column_spec(3:7, width="6em") %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Appendix: CNS NRT Goal Achievement and Satisfaction ####

```{r nrt-perf1, echo=FALSE, message=FALSE, warning=FALSE}
tmp <- 
  d_all %>% 
  filter(Group!="COVID") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Item,Role) %>% 
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),2))
# write.csv(tmp,"../tables/Appendix-CNS_NRT-Survey_2019-2023-AchieveProgramGoals.csv",
#           row.names = FALSE)
tmp %>%
  kbl(caption="CNS NRT Program Achieved Its Goals Between 2019-2023.",
      centering = TRUE) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "HOLD_position") %>% 
  
  row_spec(0, extra_css = "border-bottom: 2px solid;") %>%
  column_spec(1, width="8em") %>%
  column_spec(2, width="4em") %>%
  column_spec(3:6, width="4em") %>%
  footnote(general="Values are using responses from all years. Values are calculated by converting Likert scales to values between 1 (Strongly Disagree) and 6 (Strongly Agree). NA values were removed.",
           footnote_as_chunk = T, threeparttable = T) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Figure 5: CNS NRT Goal Achievement ####

```{r Figure5-CNS_NRT-goals, echo=FALSE, fig.align="center", fig.path="../figures/", dev=c('png','tiff'), fig.height=2.5, fig.width=10, message=FALSE, warning=FALSE, dpi=200}
#### Overall ####
# Annual count of distinct participants for each year
participant_ct <- 
  d_all %>% 
  filter(Group!="COVID") %>%
  select(Year, ResponseId) %>% 
  distinct() %>%
  group_by(Year) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Likert Value
answer_ct <- 
  d_all %>%
  filter(Group!="COVID") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Year, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value, fill=list(Count=0)) %>%
  filter(Item!="COVID-19")
# Combine Annual Participant and Answer Counts
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  complete(Item,Value, fill=list(Participants=0,Count=0,Percent=0)) %>%
  filter(Item!="COVID-19") %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
p1 <- 
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item, ncol=4) +
    scale_fill_steps(low="#EBF7FF", high="#005B94", na.value = "White",
                     limits=c(1,52)) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    guides(fill = guide_legend(theme =
                  theme(legend.text=element_text(vjust=.5, size=8)))) +
    labs(y=NULL, x="Year") +
    theme(panel.grid.major.x = element_line(color="#e7e9eb"),
          panel.spacing = unit(1, "lines"),
          axis.title.y = element_text(vjust = -10),
          strip.placement.y = "outside",
          strip.background = element_rect(fill="White"),
          strip.text.y.left = element_text(size=12),
          strip.text.x = element_text(size=12), plot.margin = margin(,.4, , , "cm"))
p1
```

####Figure 6: CNS NRT Goal Achievement - By Respondent Roles ####

```{r Figure6-CNS_NRT-goals-role, echo=FALSE, fig.path="../figures/", fig.height=8, fig.width=10, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
#### Role Level ####
# Annual count of distinct participants, by Role
participant_ct <- 
  d_all %>% 
  filter(Group!="COVID") %>%
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n()) %>%
  complete(Role, fill = list(Year=2019, Participants = 0))
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_all %>%
  filter(Group!="COVID") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Year, Role, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Role,Item,Year,fill=list(Count=0)) %>%
  filter(Item!="COVID-19")
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year", "Role")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  complete(Role,Item,Value, fill=list(Participants=0,Count=0,Percent=0)) %>%
  filter(Item!="COVID-19") %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
####Figure parts####
p1 <- 
  answer_ct %>%
  filter(Role=="Faculty") %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", bins=13, binwidth=4, drop=F) +
    facet_grid(Role~Item, switch="y") +
    scale_fill_steps(low="#EBF7FF",high="#005B94",na.value = "White",
                     limits=c(1,100),n.breaks=6) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    guides(fill = guide_legend(theme =
                  theme(legend.text=element_text(vjust=.5, size=8)))) +
    labs(y=NULL, x=NULL) +
    theme(axis.title.y = element_text(vjust = -10),  
          strip.placement = "outside",
          strip.background = element_rect(fill="White"),
          strip.text = element_text(size=10))
#Doctoral Students
p2 <- 
  answer_ct %>%
  filter(Role=="Fellow") %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", bins=13, binwidth=4, drop=F) +
    scale_fill_steps(low="#E0F7F4",high="#009480",na.value = "White",
                     limits=c(1,100),n.breaks=6) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    facet_grid(Role~Item, switch="y") +
    labs(x=NULL, y=NULL) +
    guides(fill = guide_legend(theme =
                  theme(legend.title=element_blank(),
                        legend.text=element_text(vjust=.5, size=8)))) +
    theme(axis.title.y = element_text(vjust = -10),
          strip.placement = "outside",
          strip.text.x = element_blank(),
          strip.text.y = element_text(size=10),
          strip.background = element_blank())
#Affiliates
p3 <- 
  answer_ct %>%
  filter(Role=="Affiliate") %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", bins=13, binwidth=4, drop=F) +
    scale_fill_steps(low="#FFEAD1",high="#FEC148",na.value = "White",
                     limits=c(1,100),n.breaks=6) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    facet_grid(Role~Item, switch="y") +
    labs(x=NULL, y=NULL) +
    guides(fill = guide_legend(theme =
                  theme(legend.title=element_blank(),
                        legend.text=element_text(vjust=.5, size=8)))) +
    theme(axis.title.y = element_text(vjust = -10),
          strip.placement = "outside",
          strip.text.x = element_blank(),
          strip.text.y = element_text(size=10),
          strip.background = element_blank())
#Administrators
p4 <- 
  answer_ct %>%
  filter(Role=="Admin") %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", bins=13, binwidth=4, drop=F) +
    scale_fill_steps(low="#F1E4EF",high="#5c3354",na.value = "White",
                     limits=c(1,100),n.breaks=6) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    facet_grid(Role~Item, switch="y") +
    labs(x="Years", y=NULL) +
    guides(fill = guide_legend(theme =
                  theme(legend.title=element_blank(),
                        legend.text=element_text(vjust=.5, size=8)))) +
    theme(axis.title.y = element_text(vjust = -10),
          strip.placement = "outside",
          strip.text.x = element_blank(),
          strip.text.y = element_text(size=10),
          strip.background = element_blank())
# Combine plots
(p1/p2/p3/p4)
```

####Figure 14: COVID Impact on CNS NRT Program ####

```{r Figure14-CNS_NRT-covidimpact, echo=FALSE, fig.path="../figures/", fig.height=4.5, fig.width=6, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
#### Overall ####
# Annual count of distinct participants for each year
participant_ct <- 
  d_all %>% 
  filter(Group=="COVID") %>%
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year,Role) %>% 
  dplyr::summarise(Participants = n())

# Annual counts of Item responses, by Likert Value
answer_ct <- 
  d_all %>%
  filter(Group=="COVID") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Year, Item, Role, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value,Role, fill=list(Count=0)) %>%
  filter(Item=="COVID-19")
# Combine Annual Participant and Answer Counts
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year","Role")) %>%
  select(Year,Item,Role,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
#COVID Impact
p1 <-
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, weight=Percent)) +
    geom_bar(fill ="#a90533") +
    facet_grid(Role~Year, switch = "y") +
    scale_x_continuous(expand = c(0, 0)) +
    labs(y=NULL,x="Percent") +
    theme(panel.grid.major.x = element_line(color="#e7e9eb"),
          panel.spacing = unit(1, "lines"),
          axis.title.y = element_text(vjust = -10),
          strip.placement.y = "outside",
          strip.background = element_rect(fill="White"),
          strip.text.y.left = element_text(size=12),
          strip.text.x = element_text(size=12), plot.margin = margin(,.4, , , "cm"))
p1
```

####Appendix: CNS NRT Covid Impact ####

```{r covid-19, message=FALSE, warning=FALSE}
tmp <- 
  d_all %>%
  filter(Group=="COVID") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Role,Year) %>% 
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),2))
write.csv(tmp,"../tables/Appendix-CNS_NRT-Survey_2019-2023-COVID.csv",
          row.names = FALSE)
  
tmp %>%
  kbl(caption="Impact of COVID-19 on CNS NRT Program, between 2022-2023.",
      centering = TRUE) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "HOLD_position") %>% 
  
  row_spec(0, extra_css = "border-bottom: 2px solid;") %>%
  column_spec(1, width="8em") %>%
  column_spec(2, width="4em") %>%
  column_spec(3:6, width="4em") %>%
  footnote(general="Values are using responses from all years. Values are calculated by converting Likert scales to values between 1 (Strongly Disagree) and 6 (Strongly Agree). NA values were removed.",
           footnote_as_chunk = T, threeparttable = T) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```


####Table 7: CNS NRT Doctoral Fellow Student Satisfaction ####

```{r nrt-sat1, echo=FALSE, message=FALSE, warning=FALSE}
# Student satisfaction questions
tmp <- 
  d_std %>%
  filter(Group == "Student Satisfaction") %>%
  mutate(Item = ordered(Item, 
                        levels=c("Milestone Progress", "CNS PhD Program",
                                 "2nd PhD Program","Community","Mentoring"))) %>%  
  group_by(Item, Year) %>%
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),3))
write.csv(tmp,"../tables/Table7-CNS_NRT-Survey_2019-2023-DoctoralFellow_Satisfaction.csv",
          row.names = FALSE)
tmp %>%
  kbl(caption="CNS NRT Doctoral Fellow Satisfaction, from 2019-2023.", 
      centering = TRUE,) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 2px solid") %>%
  column_spec(1, width="8em") %>%
  footnote(general="Values are calculated using Likert scales converted to values between 1 and 6.",
           footnote_as_chunk = T, threeparttable = T) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Figure 7: CNS NRT Doctoral Fellow Student Satisfaction ####

```{r Figure7-CNS_NRT-DoctoralFellow-Satisfaction, echo=FALSE, fig.align="center", fig.path="../figures/", fig.height=4.5, fig.width=7.5, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
# Student Participants - Satisfaction Questions
participant_ct <- 
  d_std %>% 
  filter(Group=="Student Satisfaction") %>%
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_std %>%
  select(Year,Variable,Value,Group,Item) %>%
  filter(Group=="Student Satisfaction") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Year, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value,fill=list(Count=0))
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
#Doctoral Fellow Satisfaction
p1 <-
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  mutate(Item=ordered(Item, levels=c("Milestone Progress","CNS PhD Program",
                                    "2nd PhD Program","Mentoring",
                                    "Community"))) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#F1E4EF",high="#5c3354",na.value = "White",
                     limits=c(1,70),n.break=7) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    guides(fill = guide_legend(theme =
                  theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank(),
          axis.title.y=element_blank())
p1

```

####Table 8: CNS NRT Academic Program Impact on Research Skills ####

```{r nrt-skills1, echo=FALSE, message=FALSE, warning=FALSE}
tmp <-
  d_std %>% 
  filter(Group=="Program Impact") %>%
  mutate(Item==ordered(Item, 
                       levels= c("Presentations","Writing","Grant Writing",
                                 "Technical Skills","Networking"))) %>%
  group_by(Item, Year) %>%
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),3))
write.csv(tmp,"../tables/Table8-CNS_NRT-Survey_2019-2023-DoctoralFellow_ProgramImpact.csv",
          row.names = FALSE)

# Make the table pretty for latex.
tmp %>%
  kbl(caption="CNS NRT Program Impact on Research Skills, from 2019-2023.", 
      centering = TRUE,) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 2px solid") %>%
  footnote(general="Values are calculated using Likert scales converted to values between 1 and 6.",
           footnote_as_chunk = T, threeparttable = T) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Figure 8: Program Impact on Doctoral Fellow Research Skills ####

```{r Figure8-CNS-NRT_DoctoralFellow-ProgramImpactSkills, echo=FALSE, fig.align="center", fig.path="../figures/", fig.height=4.5, fig.width=7.5, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
# Doctoral Fellow Participants - Research Skills
participant_ct <- 
  d_std %>% 
  filter(Group=="Program Impact") %>%
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_std %>%
  select(Year,Variable,Value,Group,Item) %>%
  filter(Group=="Program Impact") %>%
  filter(Value!="Not Applicable") %>%
  group_by(Year, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value,fill=list(Count=0))
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
#CNS Program Impact
p1 <- 
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  mutate(Item=ordered(Item, levels=c("Writing","Presentations",
                                  "Technical Skills","Grant Writing",
                                  "Networking"))) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#F1E4EF", high="#5c3354",na.value = "White",
                     limits=c(1,60), n.breaks=7) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    guides(fill = guide_legend(theme =
                theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank(),
          axis.title.y=element_blank())
p1
```

####Table 9: CNS NRT Faculty Agreement Mentorship Improves Research Skills ####

```{r nrt-mentF1, echo=FALSE, message=FALSE, warning=FALSE}
tmp <-
  d_fac %>%
  filter(Value!="Not Applicable") %>%
  group_by(Item) %>%
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),3))
write.csv(tmp,"../tables/Table9-CNS_NRT-Survey_2019-2023-Faculty_MentorshipImpact.csv",
          row.names = FALSE)

tmp %>%
  kbl(caption="CNS NRT Faculty: Mentorship Improves Fellows' Research Skills, from 2020-2023.", 
      centering = TRUE,) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 2px solid") %>%
  footnote(general="Values are calculated using Likert scales converted to values between 1 and 6.",
           footnote_as_chunk = T, threeparttable = T)  %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Figure 11: Facultys' Perception of Mentorships Impact on CNS NRT Doctoral Fellows

```{r Figure11-CNS_NRT-Faculty-Mentoship, echo=FALSE, fig.path="../figures/", fig.height=4.5, fig.width=6, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
# Faculty Participants - Mentoships Impact on Research Skills
participant_ct <- 
  d_fac %>% 
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_fac %>%
  select(Year,Variable,Value,Group,Item) %>%
  filter(Value!="Not Applicable") %>%
  group_by(Year, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value,fill=list(Count=0))
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
#Research
p1 <- 
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  mutate(Item=ordered(Item, levels=c("Research","Presentations",
                                     "Publications","Grants"))) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#E0F7F4", high="#009480",na.value = "White",
                     limits=c(1,100),n.breaks=6) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +  
    guides(fill = guide_legend(theme =
            theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank(),
          axis.title.y=element_blank())
p1
```

####Table 10: Mentorship Impact on Research Skills

```{r nrt-mentS1, echo=FALSE, message=FALSE, warning=FALSE}
tmp <-
  d_std %>% 
  filter(Group == "Mentorship Impact") %>%
  mutate(Item == ordered(Item, 
                         levels=c("Grants","Collaboration",
                                  "Interdisciplinary","Publications",
                                  "Presentations","Research"))) %>%
  group_by(Item) %>%
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),3)) %>%
  arrange(desc(Item))
write.csv(tmp,"../tables/Table10-CNS_NRT-Survey_2019-2023-DoctoralFellow_MentorshipImpact.csv",
          row.names = FALSE)

# Make table printable by Latex
tmp %>%
  kbl(caption="CNS NRT Doctoral Fellows: Mentorships have Postive Impacts on Research Skills, for 2019-2023.", 
      centering = TRUE,) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 2px solid") %>% 
  footnote(general="Values are calculated using Likert scales converted to values between 1 and 6.",
           footnote_as_chunk = T, threeparttable = T) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Figure 12. Mentorships Impact on CNS NRT Doctoral Fellows

```{r Figure12-CNS_NRT-DoctoralFellow_MentorshipImpact, echo=FALSE, fig.align="center", fig.path="../figures/", fig.height=5, fig.width=8, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
# Fellows Participants - Mentorship Impact on Research Skills
participant_ct <- 
  d_std %>% 
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_std %>%
  filter(Group == "Mentorship Impact") %>%
  select(Year,Variable,Value,Group,Item) %>%
  filter(Value!="Not Applicable") %>%
  mutate(Item == ordered(Item, 
                         levels=c("Grants","Collaboration",
                                  "Interdisciplinary","Publications",
                                  "Presentations","Research"))) %>%
  group_by(Year, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value,fill=list(Count=0))
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
# Mentorship Impact
p1 <- 
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  mutate(Item=ordered(Item, levels=c("Research","Publications","Presentations",
                                     "Grants","Collaboration","Interdisciplinary"))) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#E0F7F4", high="#009480",na.value = "White",
                     limits=c(1,60), n.breaks=5) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    guides(fill = guide_legend(theme =
                theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank(),
          axis.title.y=element_blank())
# Combine plots
p1
```

####Table 11: Quality of Mentor ####

```{r nrt-mentS3, echo=FALSE, message=FALSE, warning=FALSE}
# Student satisfaction questions
tmp <-
  d_std %>%  
  filter(Group=="Mentor Quality") %>%
  group_by(Item) %>%
  dplyr::summarise(Responses = n(),
                   Median = round(median(as.numeric(Value)),1),
                   Mean = round(mean(as.numeric(Value)),1),
                   SD = round(sd(as.numeric(Value)),3))
# write.csv(tmp,"../tables/CNS_NRT-Survey_2019-2023-DoctoralFellow_MentorshipQuality.csv",
#           row.names = FALSE)
tmp %>%
  kbl(caption="CNS NRT Doctoral Fellow: Quality of Mentorships Relationships, for 2019-2023.", 
      centering = TRUE,) %>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F,
                position = "center",
                latex_options = "HOLD_position") %>% 
  row_spec(0, extra_css = "border-bottom: 2px solid") %>% 
  footnote(general="Values are calculated using Likert scales converted to values between 1 and 6.",
           footnote_as_chunk = T, threeparttable = T) %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "top")
```

####Figure 13:  Quality with Mentorship for CNS NRT Doctoral ####

```{r Figure13-CNS_NRT-DoctoralFellow-MentorshipQuality, echo=FALSE, fig.align="center", fig.path="../figures/", fig.height=6.5, fig.width=9, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
# Fellows Participants - Mentorship Impact on Research Skills
participant_ct <- 
  d_std %>% 
  select(Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_std %>%
  filter(Group == "Mentor Quality") %>%
  select(Year,Variable,Value,Group,Item) %>%
  filter(Value!="Not Applicable") %>%
  mutate(Item == ordered(Item, 
                         levels=c("Grants","Collaboration",
                                  "Interdisciplinary","Publications",
                                  "Presentations","Research"))) %>%
  group_by(Year, Item, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Year,Value,fill=list(Count=0))
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
#Mentorship Quality
p1 <- 
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#E0F7F4", high="#009480",na.value = "White",
                     limits=c(1,60),n.breaks=7) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    labs(y=NULL) +
    guides(fill = guide_legend(theme =
                theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank())
p1
```

####Figure 9: Program Impact on Doctoral Fellow Sense of Interdisciplinary ####

```{r Figure9-CNS_NRT-DoctoralFellow-ProgramImpact-Interdisciplinary, echo=FALSE, fig.align="center", fig.path="../figures/", fig.height=2.5, fig.width=8, dev=c('png','tiff'), message=FALSE, warning=FALSE, dpi=200}
# Fellows Participants - Program Impact on CNS Fellow Interdisciplinarity
participant_ct <-
  d_std %>% 
  filter(Group %in% c("CNS Program")) %>%
  select(Year,Role,ResponseId) %>%
  distinct() %>%
  group_by(Year, Role) %>% 
  dplyr::summarise(Participants = n())

# Annual counts of Item responses, by Role, and Likert Value
answer_ct <-
  d_std %>% 
  filter(Group %in% c("CNS Program")) %>%
  filter(!is.na(Value)) %>%
  group_by(Year, Item, Value) %>%
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Item,Value,Year,fill=list(Count=0))
# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year")) %>%
  select(Year,Role,Item,Value,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Item,Role,Year,Item,desc(Value)) %>%
  filter(Year!=2019)
# Figure
p1 <- 
  answer_ct %>%
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, weight=Percent)) +
    geom_bar(fill ="#5c3354") +
    facet_wrap(~Year,nrow=1) +
    scale_x_continuous(expand = c(0, 0)) +
    labs(y=NULL,x="Percent") +
    guides(fill = guide_legend(theme =
                theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(panel.grid.major.x = element_line(color="#e7e9eb"),
          strip.background = element_blank())
p1
```

####Figure 10: Doctoral Fellows Interdisciplinary Values and Impact on Research Skills ####

```{r Figure10-CNS_NRT-DoctoralFellow-Interdisciplinary, fig.align="center", fig.path="../figures/", fig.height=9.5, fig.width=7.5, dev=c('png','tiff'), dpi=200, message=FALSE, warning=FALSE}
# Fellows Participants - Interdisciplinary Questions
participant_ct <- 
  d_std %>% 
  filter(Group %in% c("Academic Research","Personal Values")) %>%
  select(Group, Year, Role, ResponseId) %>% 
  distinct() %>%
  group_by(Group, Year, Role) %>% 
  dplyr::summarise(Participants = n())
# Annual counts of Item responses, by Role, and Likert Value
answer_ct <- 
  d_std %>% 
  filter(Group %in% c("Academic Research","Personal Values")) %>%
  select(Group,Item,Year,Variable,Value) %>%
  filter(Value!="Not Applicable") %>%
  mutate(Group=ordered(Group, levels=c("Academic Research",
                                        "Personal Values")),
         Item=ordered(Item, 
                       levels=c("Openness","Learning","Thinking","Frameworks","New Methods","Complex Problems",
                                "Challenges","Perspectives","Collaboration","Fields","Methods","Time Investment"))) %>%
  group_by(Group, Item, Year, Value) %>% 
  dplyr::summarise(Count = n()) %>%
  ungroup() %>%
  complete(Group,Item,Year,Value,fill=list(Count=0))

# Combine Annual Participant and Answer Counts, by Role
# Calculate Percentage of Answers for each Item and Likert Value
answer_ct <- 
  plyr::join(participant_ct, answer_ct, 
             by=c("Year","Group")) %>%
  select(Group,Item,Value,Year,Participants,Count) %>%
  mutate(Percent=round(Count/Participants*100,2)) %>%
  filter(!is.na(Value)) %>%
  arrange(Group,Item,Year,desc(Value))
answer_ct[answer_ct$Percent==0,]$Percent <- NA
#### Figure Parts ####
#Interdisciplinary Impact on Academic Research
p1 <- 
  answer_ct %>%
  filter(Group=="Academic Research") %>% 
  filter(Item %in% c("Openness","Learning","Thinking","Frameworks",
                     "New Methods","Complex Problems")) %>% 
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#F1E4EF", high="#5c3354",na.value = "White",
                     limits=c(1,60), n.breaks=7) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    labs(y=NULL,tag="A") +
    guides(fill = guide_legend(theme =
                theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank())
#Interdisciplinary Impact on Personal Values
p2 <- 
  answer_ct %>%
  filter(Group=="Personal Values") %>%
  filter(Item %in% c("Challenges","Perspectives","Collaboration",
                     "Fields","Methods","Time Investment")) %>% 
  mutate(Year=factor(Year)) %>%
  ggplot(aes(y=Value, x=Year)) +
    stat_bin_2d(aes(fill=Percent), color="#D3D3D3", drop=F) +
    facet_wrap(~Item) +
    scale_fill_steps(low="#F1E4EF", high="#5c3354",na.value = "White",
                     limits=c(1,60), n.breaks=7) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    labs(y=NULL, tag="B") +
    guides(fill = guide_legend(theme =
                theme(legend.text=element_text(vjust=.5, size=8)))) +
    theme(strip.background = element_blank())

p1 / p2
```
